<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Sessões</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    a { color: black; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h1 class="mb-4">Gerenciar Sessões</h1>

  <div class="card shadow p-4 mb-5">
    <h3 class="mb-3">Agendar Nova Sessão</h3>

    <form th:action="@{/coordenador/criar-sessao}" th:object="${novaReuniao}" method="post">

      <div th:if="${#fields.hasGlobalErrors()}" th:each="err : ${#fields.globalErrors()}" class="alert alert-danger mb-3" th:text="${err}"></div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Data e Hora:</label>
          <input type="datetime-local" th:field="*{dataReuniao}" class="form-control"/>
          <div th:if="${#fields.hasErrors('dataReuniao')}" class="text-danger" th:errors="*{dataReuniao}"></div>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-bold">Colegiado:</label>
          <select th:field="*{colegiadoId}" class="form-select">
            <option value="">Selecione...</option>
            <option th:each="c : ${listaColegiados}" th:value="${c.id}" th:text="${c.descricao}"></option>
          </select>
          <div th:if="${#fields.hasErrors('colegiadoId')}" class="text-danger" th:errors="*{colegiadoId}"></div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Definir Pauta (Selecione os Processos):</label>

        <details class="border rounded p-2 bg-white">
          <summary class="form-control" style="cursor:pointer;">
            Clique para selecionar os processos para julgamento...
          </summary>

          <div class="border" style="max-height: 200px; overflow-y: auto; padding: 10px;">
            <div th:each="proc : ${processosDisponiveis}" class="form-check border-bottom py-1">

              <input class="form-check-input"
                     type="checkbox"
                     th:field="*{processosIds}"
                     th:value="${proc.id}"
                     th:id="${'proc_' + proc.id}" />

              <label class="form-check-label w-100" th:for="${'proc_' + proc.id}">
                <span class="fw-bold" th:text="${'Processo nº ' + proc.numero}"></span>
                <span th:text="${' - ' + proc.assunto.nome}"></span>
                <span class="text-muted fst-italic" th:text="${' (Aluno: ' + proc.interessado.usuario.nome + ')'}"></span>
              </label>
            </div>

            <div th:if="${#lists.isEmpty(processosDisponiveis)}" class="text-center text-muted mt-2">
              Nenhum processo pendente disponível para pauta.
            </div>
          </div>
        </details>
        <div th:if="${#fields.hasErrors('processosIds')}" class="text-danger mt-1" th:errors="*{processosIds}"></div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success">Salvar Sessão</button>
        <button type="reset" class="btn btn-secondary">Limpar</button>
      </div>
    </form>
  </div>

  <hr/>

  <h3 class="mb-3">Sessões Cadastradas</h3>
  <table class="table table-striped table-hover shadow">
    <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Data/Hora</th>
      <th>Colegiado</th>
      <th>Status</th>
      <th>Pauta</th>
      <th>Ações</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="reuniao : ${sessao}">
      <td th:text="${reuniao.id}"></td>
      <td th:text="${#dates.format(reuniao.dataReuniao, 'dd/MM/yyyy HH:mm')}"></td>
      <td th:text="${reuniao.colegiado != null ? reuniao.colegiado.descricao : '-'}"></td>
      <td>
        <span class="badge" th:classappend="${reuniao.status.name() == 'PROGRAMADA' ? 'bg-primary' : 'bg-secondary'}" th:text="${reuniao.status}"></span>
      </td>
      <td>
        <details th:if="${not #lists.isEmpty(reuniao.processos)}">
          <summary class="fw-bold" style="cursor:pointer;"><span th:text="${#lists.size(reuniao.processos)} + ' processos'"></span></summary>
          <ul class="mt-2 small">
            <li th:each="p : ${reuniao.processos}" th:text="${'Nº ' + p.numero + ' (' + p.assunto.nome + ')'}"></li>
          </ul>
        </details>
        <span th:if="${#lists.isEmpty(reuniao.processos)}" class="text-muted">Sem pauta</span>
      </td>
      <td class="d-flex gap-2">
        <form th:action="@{/coordenador/iniciar-sessao/{id}(id=${reuniao.id})}" method="post">
            <button type="submit"
                    class="btn btn-primary btn-sm">
                <i class="bi bi-play-circle"></i> Conduzir
            </button>
        </form>


        <form th:action="@{/coordenador/deletar-sessao/{id}(id=${reuniao.id})}" method="post">
          <button type="submit"
                  class="btn btn-sm btn-danger"
                  onclick="return confirm('Tem certeza que deseja cancelar esta sessão?');">
            Excluir
          </button>
        </form>
      </td>
    </tr>
    </tbody>
  </table>
  <a th:href="@{/coordenador/home-coordenador}" class="btn btn-dark mt-3">Voltar ao Painel</a>
</div>
</body>
</html>